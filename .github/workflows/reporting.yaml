---
# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Linux Foundation

name: "ðŸ“Š Project Reports"

# yamllint disable-line rule:truthy
on:
  workflow_dispatch:
  schedule:
    # Run every Monday at 7:00 AM UTC
    - cron: '0 7 * * 1'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions: {}

jobs:
  verify:
    name: "Verify Configuration"
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.parse-projects.outputs.matrix }}
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: 'audit'

      - name: "Checkout repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: "Verify PROJECTS_JSON variable content"
        shell: bash
        run: |
          if [ -z "${{ vars.PROJECTS_JSON }}" ]; then
            echo "::error::PROJECTS_JSON variable is not set"
            exit 1
          fi

          echo "PROJECTS_JSON variable exists"
          echo "Raw content: ${{ vars.PROJECTS_JSON }}"

      - name: "Parse and validate JSON structure"
        id: parse-projects
        shell: bash
        run: |
          # Parse PROJECTS_JSON and verify structure
          projects_json='${{ vars.PROJECTS_JSON }}'

          # Validate JSON syntax
          if ! echo "$projects_json" | jq . > /dev/null 2>&1; then
            echo "::error::PROJECTS_JSON contains invalid JSON"
            exit 1
          fi

          # Validate required fields exist
          if ! echo "$projects_json" | jq -e 'type == "array"' > /dev/null; then
            echo "::error::PROJECTS_JSON must be an array"
            exit 1
          fi

          # Check each project has required fields
          if ! echo "$projects_json" | \
            jq -e 'all(.project and .server)' > /dev/null; then
            echo "::error::Each project must have 'project' and 'server' fields"
            exit 1
          fi

          # Count projects
          project_count=$(echo "$projects_json" | jq '. | length')
          echo "Found $project_count project(s) to process"

          # Create matrix for parallel execution
          matrix=$(echo "$projects_json" | jq -c '{include: .}')
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

          {
            echo "## Configuration Validation âœ…"
            echo "- **Projects found:** $project_count"
            echo "- **JSON structure:** Valid"
            echo ""
            echo "### Projects:"
          } >> "$GITHUB_STEP_SUMMARY"
          echo "$projects_json" | \
            jq -r '.[] | "- **\(.project):** \(.server)"' >> \
            "$GITHUB_STEP_SUMMARY"

  analyze:
    name: "Analyze ${{ matrix.project }}"
    needs: verify
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.verify.outputs.matrix) }}
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: 'audit'

      - name: "Checkout repository"
        # yamllint disable-line rule:line-length
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: "Clone Gerrit repositories for ${{ matrix.project }}"
        # Temporarily use fork until merged upstream
        # yamllint disable-line rule:line-length
        uses: modeseven-lfreleng-actions/gerrit-clone-action@main # latest
        id: clone
        with:
          host: ${{ matrix.server }}
          path-prefix: "./gerrit-repos"
          skip-archived: "true"
          threads: "4"
          clone-timeout: "300"
          use-https: "true"

      - name: "Analyze cloned repository structure for ${{ matrix.project }}"
        shell: bash
        run: |
          project="${{ matrix.project }}"
          echo "ðŸ“ Analyzing cloned repository structure for $project"
          echo "## ðŸ“ Repository Structure Analysis for $project" >> \
            "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          # Check if the gerrit-repos directory exists
          if [ -d "./gerrit-repos" ]; then
            echo "ðŸ” Listing repository structure:"

            # Calculate and display disk usage
            echo -e "### ðŸ’¾ Disk Usage Analysis:\n" >> "$GITHUB_STEP_SUMMARY"

            # Overall size
            total_size=$(du -sh ./gerrit-repos | cut -f1)
            echo "ðŸ“Š Total downloaded data: $total_size"

            # Count repositories
            repo_count=$(find ./gerrit-repos -maxdepth 1 -type d \
              -not -name "gerrit-repos" 2>/dev/null | wc -l)
            echo "ðŸ“ˆ Top-level Project/Folders: $repo_count"

            {
              echo "ðŸ“Š **Total downloaded data:** $total_size"
              echo "ðŸ“ˆ **Top-level Project/Folders:** $repo_count"
            } >> "$GITHUB_STEP_SUMMARY"

            # Show largest repositories (top 10)
            {
              echo ""
              echo "#### ðŸ† Largest Repositories:"
              echo ""
              echo "| Size | Repository |"
              echo "|------|------------|"
              du -sh ./gerrit-repos/* 2>/dev/null | \
                sed 's|./gerrit-repos/||' | sort -hr | head -10 | \
              awk '{printf "| %s | %s |\n", $1, $2}' || true
              echo ""
            } >> "$GITHUB_STEP_SUMMARY"

            # Show directory structure summary
            # Count different types of content
            total_dirs=$(find ./gerrit-repos -type d 2>/dev/null | wc -l)
            total_files=$(find ./gerrit-repos -type f 2>/dev/null | wc -l)
            repo_size_mb=$(du -sm ./gerrit-repos | cut -f1)
            avg_size=$(echo "scale=2; $repo_size_mb / $repo_count" | \
              bc 2>/dev/null || echo "N/A")

            {
              echo ""
              echo "#### ðŸ“‹ Summary Statistics:"
              echo "- **Total directories:** $total_dirs"
              echo "- **Total files:** $total_files"
              echo "- **Average size per repository:** ${avg_size}MB"
              echo ""
            } >> "$GITHUB_STEP_SUMMARY"

            echo "âœ… Repository structure analysis completed"
          else
            echo "âŒ gerrit-repos directory not found"
            echo "- **Status:** âŒ No repository data found" >> \
              "$GITHUB_STEP_SUMMARY"
          fi

      - name: "Set up Python environment for ${{ matrix.project }}"
        # yamllint disable-line rule:line-length
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: "Install Python dependencies"
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "Validate repository data for ${{ matrix.project }}"
        shell: bash
        run: |
          project="${{ matrix.project }}"
          echo "ðŸ” Validating repository data for $project"

          # Check if gerrit-repos directory exists and has content
          if [ ! -d "./gerrit-repos" ]; then
            echo "âŒ No repository data found - gerrit-repos directory missing"
            {
              echo "## âŒ Analysis Failed for $project"
              # yamllint disable-line rule:line-length
              echo "**Reason:** No repository data (clone may have failed)"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          # Count actual repositories (exclude hidden dirs and files)
          # yamllint disable-line rule:line-length
          repo_count=$(find ./gerrit-repos -maxdepth 1 -type d \
            -not -name ".*" -not -name "gerrit-repos" | wc -l)

          if [ "$repo_count" -eq 0 ]; then
            {
              echo "## âŒ Analysis Failed for $project"
              echo "**Reason:** No repositories available for analysis"
            } >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

          echo "âœ… Found $repo_count repositories to analyze"
          {
            echo "## ðŸ” Repository Validation for $project"
            echo "- **Repositories found:** $repo_count"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: "Run comprehensive analytics for ${{ matrix.project }}"
        shell: bash
        run: |
          project="${{ matrix.project }}"
          echo "ðŸ“Š Starting comprehensive analytics for $project"

          # Execute the comprehensive reporting system with error handling
          if python3 generate_reports.py \
            --project "$project" \
            --repos-path "./gerrit-repos" \
            --config-dir "./configuration" \
            --output-dir "./reports" \
            --verbose; then

            echo "âœ… Analytics completed successfully for $project"

            # Report on generated files
            report_dir="./reports/$project"
            if [ -d "$report_dir" ]; then
              {
                echo "## ðŸ“Š Analytics Success for $project"
                # yamllint disable-line rule:line-length
                echo "**Status:** âœ… Report generation completed"
                echo ""
              } >> "$GITHUB_STEP_SUMMARY"

              # List generated files with sizes
              echo "### Generated Files:" >> "$GITHUB_STEP_SUMMARY"
              for file in "$report_dir"/*; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  # yamllint disable-line rule:line-length
                  size=$(stat -f%z "$file" 2>/dev/null || \
                    stat -c%s "$file" 2>/dev/null || echo "N/A")
                  # yamllint disable-line rule:line-length
                  echo "- **$filename:** ${size} bytes" \
                    >> "$GITHUB_STEP_SUMMARY"
                fi
              done
            fi
          else
            exit_code=$?
            echo "âŒ Analytics failed for $project (exit code: $exit_code)"
            {
              echo "## âŒ Analytics Failed for $project"
              echo "**Status:** Failed with exit code $exit_code"
              # yamllint disable-line rule:line-length
              echo "**Recommendation:** Check logs for error information"
            } >> "$GITHUB_STEP_SUMMARY"
            exit $exit_code
          fi

      - name: "Upload comprehensive analysis results"
        if: always()
        # yamllint disable-line rule:line-length
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882 # v4.4.3
        with:
          name: reports-${{ matrix.project }}
          path: |
            ./gerrit-repos/clone-manifest.json
            ./reports/${{ matrix.project }}/
          retention-days: 30
          if-no-files-found: warn

  summary:
    name: "Generate Summary Report"
    needs: [verify, analyze]
    if: always()
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      # Harden the runner used by this workflow
      # yamllint disable-line rule:line-length
      - uses: step-security/harden-runner@ec9f2d5744a09debf3a187a3f4f675c53b671911 # v2.13.0
        with:
          egress-policy: 'audit'

      - name: "Download all analysis results"
        # yamllint disable-line rule:line-length
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          pattern: reports-*
          path: ./results

      - name: "Generate workflow summary"
        shell: bash
        run: |
          {
            echo "## ðŸ“Š Project Reports Summary"
            echo ""
            echo "**Workflow completed:** $(date -u)"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          # Count results
          result_count=$(find ./results -name "reports-*" -type d | wc -l)
          {
            echo "** Reports generated:** $result_count project(s) processed"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          # List processed projects with report details
          if [ -d "./results" ]; then
            echo "### ðŸ“Š Generated Reports:" >> "$GITHUB_STEP_SUMMARY"
            for result_dir in ./results/reports-*; do
              if [ -d "$result_dir" ]; then
                project_name=$(basename "$result_dir" | sed 's/reports-//')
                echo "#### âœ… $project_name" >> "$GITHUB_STEP_SUMMARY"

                # Check for report files and show what was generated
                project_reports_dir="$result_dir/$project_name"
                if [ -d "$project_reports_dir" ]; then
                  echo "**Generated Files:**" >> "$GITHUB_STEP_SUMMARY"

                  if [ -f "$project_reports_dir/report_raw.json" ]; then
                    size=$(stat -f%z "$project_reports_dir/report_raw.json" \
                      2>/dev/null \
                      || stat -c%s "$project_reports_dir/report_raw.json" \
                        >/dev/null || echo "N/A")
                    echo "- ðŸ“„ JSON Report: ${size} bytes" \
                      >> "$GITHUB_STEP_SUMMARY"
                  fi

                  if [ -f "$project_reports_dir/report.md" ]; then
                    echo "- ðŸ“ Markdown Report: Generated" \
                      >> "$GITHUB_STEP_SUMMARY"
                  fi

                  if [ -f "$project_reports_dir/report.html" ]; then
                    echo "- ðŸŒ HTML Report: Generated" \
                      >> "$GITHUB_STEP_SUMMARY"
                  fi

                  for bundle in "$project_reports_dir"/*_report_bundle.zip; do
                    if [ -f "$bundle" ]; then
                      bundle_size=$(stat -f%z "$bundle" 2>/dev/null \
                        || stat -c%s "$bundle" 2>/dev/null \
                        || echo "N/A")
                      echo "- ðŸ“¦ ZIP Bundle: ${bundle_size} bytes" \
                        >> "$GITHUB_STEP_SUMMARY"
                      break  # Only report the first bundle found
                    fi
                  done
                else
                  echo "- âš ï¸ Report directory not found" \
                    >> "$GITHUB_STEP_SUMMARY"
                fi
                echo "" >> "$GITHUB_STEP_SUMMARY"
              fi
            done
          fi
